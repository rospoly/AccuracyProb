\documentclass[10pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{relsize}
\usepackage{nicefrac}
\usepackage{bbm}
\usepackage{color}
\usepackage[all]{xy}
\usepackage{listings}
\lstset{
	language=C,
	basicstyle=\ttfamily,
	keywordstyle=\color{blue},
	morekeywords={half}
}
\usepackage[left=2cm,right=2cm,top=2cm,bottom=2cm]{geometry}

\theoremstyle{plain}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{example}[theorem]{Example}
\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{assumption}[theorem]{Assumption}
\newtheorem{remark}[theorem]{Remark}

%% OBJECTS
\newcommand{\F}[1][n,p]{\mathbb{F}_{#1}}
\newcommand{\Ff}[1][n,p]{\overline{\mathbb{F}}_{#1}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\B}{\mathbb{B}}

%% MORPHISMS
\newcommand{\Rep}[1][n,p]{\mathrm{i}_{#1}}
\newcommand{\Round}[1][n,p]{\mathrm{r}_{#1}}
\newcommand{\one}{\mathbbm{1}}
\newcommand{\id}{\mathrm{Id}}

%% DISTRIBUTIONS
\newcommand{\Unif}{\mathsf{Uniform}}

%% MATHS
\newcommand{\ceil}[1]{\lceil #1 \rceil}
\newcommand{\floor}[1]{\lfloor #1 \rfloor}
\newcommand{\intvl}[1]{\mathlarger{\left[\right.}  #1 \mathlarger{\left.\right]}}
\newcommand{\inv}{^{-1}}
\newcommand{\fintvl}[1][x]{\intvl{\floor{#1},\ceil{#1}}}
\newcommand{\fp}{_{\mathrm{fp}}}
\newcommand{\absv}[1]{\vert #1\vert}
\newcommand{\Pro}[1]{\mathbb{P}\left[ #1 \right]}

\begin{document}
\subsection*{Notation}
Let $\Round:\R\to\F$ be the rounding map and $\Rep: \F\to \R$ the representation map. Since $\Round$ is monotone it follows that for each $n\in\F$ the set $\Round\inv(n):=\{x\in\R\mid \Round(x)=n\}$ is an interval (closed or open, it doesn't matter for what follows). In particular, given $x\in \R$ the set
\[
\Round\inv(\Round(x))=\{z\in\R\mid \Round(z)=\Round(x)\}
\]
is an interval. We define
\begin{enumerate}
\item $\ceil{x}=\sup \Round\inv(\Round(x))$
\item $\floor{x}=\inf \Round\inv(\Round(x))$
\end{enumerate}
Moreover, each interval $\fintvl$ contains a machine representable real which we denote by $\hat{x}$ and which is defined by
\[
\hat{x}:=\Rep(\Round(x))\in \intvl{\floor{x},\ceil{x}}
\]

\subsection*{Modelling floating-point arithmetic probabilistically.}

Using the notation above we can define a Markov chain $u$ on $\R$ as follows
\[
u(x):=\Unif(\fintvl),
\]
the uniform distribution on $\fintvl$ whose pdf is given by $f(t)=\frac{1}{(\ceil{x}-\floor{x})}\one_{\fintvl}(t)$

We now model floating-point arithmetic operations. Given $\diamond\in \{+,-,\times,/\}$ we define $\widehat{\diamond}:\F\times \F\to \F$ as the machine implementation of $\diamond$, and we also define $\diamond\fp$ as the Markov chain on $\R\times \R$ given by
\[
\diamond\fp:=u\circ\diamond.
\]
For example:
\[
x+\fp y:=\Unif\fintvl[x+y]
\]
It follows from the IEEE 754 standard that
\[
(\Round)_\ast(x\diamond\fp y)=\delta_{\Round(x)~\widehat{\diamond}~\Round(y)}
\]
or, alternatively for $x,y\in\F$
\[
\Rep(x~\widehat{\diamond}~y)=\widehat{\Rep(x)\diamond \Rep(y)}
\]

\subsection*{Probabilistic floating-point arithmetic on probabilistic inputs.}

Given two probability measure $\mu,\nu$ on the inputs of an arithmetic operation (i.e.\@ on $\R$), we can compute the probability of the output as the probability measure given by
\[
(\diamond\fp)_\ast(\mu\times\nu)=u_\ast\circ \diamond_\ast (\mu\times \nu)
\]
which assigns to an interval $\intvl{a,b}$ the probability
\begin{equation}\label{eq:noisyoperation}
\int_{-\infty}^{\infty} u(x)\left(\intvl{a,b}\right) ~d\diamond_\ast(\mu\times \nu)
\end{equation}
If we assume that $\mu,\nu$ are absolutely continuous w.r.t. the Lebesgue measure $\lambda$ we can find two density functions $\nicefrac{d\mu}{d\lambda}:=f_\mu,\nicefrac{d\nu}{d\lambda}:=f_\nu$ such that
\[
\mu(A)=\int_A f_\mu(x)~dx\qquad\text{and}\qquad\nu(A)=\int_A f_\nu(x)~dx
\]
The probability measure $\diamond\ast(\mu\times \nu)$ is then absolutely continuous with respect to the Lebesgue measure and we can then compute it density (see \cite{springer1979algebra}).

\begin{align}
\frac{d(+)_\ast(\mu\times\nu)}{d\lambda}(t)&=\int_{-\infty}^{\infty} f_\mu(x)f_\nu(t-x)~dx\label{eq:pdfplus}\\
\frac{d(-)_\ast(\mu\times\nu)}{d\lambda}(t)&=\int_{-\infty}^{\infty} f_\mu(x)f_\nu(x-t)~dx\label{eq:pdfminus}\\
\frac{d(\times)_\ast(\mu\times\nu)}{d\lambda}(t)&=\int_{-\infty}^{\infty} \frac{1}{\absv{x}}f_\mu(x)f_\nu\left(\frac{t}{x}\right)dx\label{eq:pdftimes}\\
\frac{d(/)_\ast(\mu\times\nu)}{d\lambda}(t)&=\int_{-\infty}^{\infty} \absv{x}f_\mu(x)f_\nu(tx)dx\label{eq:pdfdiv}
\end{align}

From this we can compute \eqref{eq:noisyoperation}. Let $f$ be any of the densities above, \eqref{eq:noisyoperation} amounts to computing
\[
\int_a^b u(x)\left(\intvl{a,b}\right) f(x) ~dx
\]
Assume that $a,b$ are machine representable numbers and that $a\neq b$. Given $x\in \R$ there are four possibilities
\begin{enumerate}
\item $\fintvl \cap \intvl{a,b}=\emptyset$, i.e.\ $\ceil{x}<a$ or $b>\floor{x}$ in which case 
\[
u(x)\left(\intvl{a,b}\right)=0
\]
\item  $\floor{x}\leq a\leq \ceil{x}<b$ in which case
\[
u(x)\left(\intvl{a,b}\right)=\frac{\ceil{x}-a}{\ceil{x}-\floor{x}}
\]
\item $\fintvl \subseteq \intvl{a,b}$, i.e.\ $a<\floor{x}, \ceil{x}<b$ in which case
\[
u(x)\left(\intvl{a,b}\right)=1
\]
\item  $a< \floor{x}\leq b<\ceil{x}$ in which case
\[
u(x)\left(\intvl{a,b}\right)=\frac{b-\floor{x}}{\ceil{x}-\floor{x}}
\]
\end{enumerate}
Since we've assumed that $a<b$ are machine representable, as $x$ varies from $-\infty$ to $\infty$ each of the cases described above occur in the order 1.2.3.4.1. We can thus partition $\R$ into five intervals. 
\begin{enumerate}
\item On $\left(-\infty,\floor{a}\right)$ we have $\ceil{x}<a$ and thus
\[
\int_{-\infty}^{\floor{a}} u(x)\left(\intvl{a,b}\right) f(x) ~dx=0
\]
\item On $\fintvl[a]$ we have $\floor{x}=\floor{a}\leq a\leq \ceil{a}=\ceil{x}$ and thus
\[
\int_{\floor{a}}^{\ceil{a}} u(x)\left(\intvl{a,b}\right) f(x) ~dx=\frac{\ceil{a}-a}{\ceil{a}-\floor{a}}\int_{\floor{a}}^{\ceil{a}}  f(x) ~dx
\]
\item On $\left(\ceil{a},\floor{b}\right)$ we have  i.e.\ $a<\floor{x}, \ceil{x}<b$ and thus
\[
\int_{\ceil{a}}^{\floor{b}} u(x)\left(\intvl{a,b}\right) f(x) ~dx=\int_{\ceil{a}}^{\floor{b}} f(x)~dx
\]
(Note that if $b$ is the next machine representable number after $a$ we have $\left(\ceil{a},\floor{b}\right)=\emptyset$ and this case drops out.)
\item On $\fintvl[b]$ we have $\floor{x}=\floor{b}\leq b\leq \ceil{b}=\ceil{x}$ and thus
\[
\int_{\floor{b}}^{\ceil{b}} u(x)\left(\intvl{a,b}\right) f(x) ~dx=\frac{b-\floor{b}}{\ceil{b}-\floor{b}}\int_{\floor{b}}^{\ceil{b}}  f(x) ~dx
\]
\item Finally, on $\left(\ceil{b},\infty\right)$ we have
\[
\int_{\ceil{b}}^{\infty} u(x)\left(\intvl{a,b}\right) f(x) ~dx=0
\]
\end{enumerate}

\noindent It follows that when $a<b$ are machine representable we can write \eqref{eq:noisyoperation} as
\begin{align*}
\int_{-\infty}^{\infty} u(x)\left(\intvl{a,b}\right) ~d\diamond_\ast(\mu\times \nu)=\frac{\ceil{a}-a}{\ceil{a}-\floor{a}}\int_{\floor{a}}^{\ceil{a}}  f(x) ~dx + \int_{\ceil{a}}^{\floor{b}} f(x)~dx +
\frac{b-\floor{b}}{\ceil{b}-\floor{b}}\int_{\floor{b}}^{\ceil{b}}  f(x) ~dx
\end{align*}
We can also compute the pdf of the probability measure $(\diamond\fp)_\ast(\mu\times \nu)$ defined by \eqref{eq:noisyoperation}. We have
\begin{align*}
(\diamond\fp)_\ast(\mu\times \nu)((-\infty,t))&=\int_{-\infty}^\infty u(x)(-\infty,t))f(x) ~dx\\
&=\int_{-\infty}^\infty \int_{-\infty}^t \frac{1}{\ceil{x}-\floor{x}} \one_{\fintvl}(y) f(x) ~dy dx\\
&=\int_{-\infty}^t\int_{-\infty}^\infty\frac{1}{\ceil{x}-\floor{x}} \one_{\fintvl}(y) f(x) ~dx dy
\end{align*}
where the last step is imply an application of Fubini's theorem. It follows that
\begin{align*}
\frac{d}{dt}(\diamond\fp)_\ast(\mu\times \nu)((-\infty,t))&=\int_{-\infty}^\infty\frac{1}{\ceil{x}-\floor{x}} \one_{\fintvl}(t) f(x) ~dx\\
&=\int_{\floor{t}}^{\ceil{t}}\frac{f(x)}{\ceil{t}-\floor{t}} ~dx
\end{align*}
This holds for \emph{any} initial density, in other words if $\mu$ is a probability measure with Lebesgue density $\nicefrac{d\mu}{d\lambda}=f$, then $u_\ast(\mu)$ has density
\begin{equation}
\frac{du_\ast(\mu)}{d\lambda}(t)=\int_{\floor{t}}^{\ceil{t}}\frac{f(x)}{\ceil{t}-\floor{t}} ~dx \label{eq:updf}
\end{equation}

\subsection*{Simple test programs}

\begin{lstlisting}
/* Precondition: Input is distributed uniformly on [0,1] */

half x = ReadInput();
if (x>0.25){
  return TRUE;}
else{
  return FALSE;} 
\end{lstlisting}

Let us call the program above $\tt Prog$ and assume that the input is a real number drawn randomly and uniformly from $\intvl{0,1}$. The function \texttt{ReadInput} rounds the input to a half-precision floating-point number. The variable $\tt x$ is thus distributed according to
\[
(\Round[5,10])_\ast(\Unif(0,1))
\]
For $X\sim\Unif(0,1)$ we are interested in computing the probability of misclassification, i.e.\@
\[
\Pro{\mathtt{Prog}(X)=\mathtt{FALSE}\mid X> 0.25}
\]
This can be computed explicitly as
\begin{align*}
\Pro{\mathtt{Prog}(X)=\mathtt{FALSE}\mid X\leq 0.25}&=\frac{\Pro{\mathtt{Prog}(X)=\mathtt{FALSE} \wedge X\leq 0.25}}{\Pro{X> 0.25}}\\
&=\frac{\Pro{X\in \{x\mid x>0.25 \wedge \Round[5,10](x)\leq 0.25\}}}{0.75}\\
&=\frac{\ceil{0.25}-0.25}{0.75}
\end{align*}

More generally if $X$ is distributed according to some density $f_X$ and $C$ is the machine-representable value of the threshold we have
\[
\Pro{\mathtt{Prog}(X)=\mathtt{FALSE}\mid X> C}=\frac{\int_C^{\ceil{C}} f_X(x)~dx}{\int_{x>C} f_X(x)~dx}
\]

%\[
%\xymatrix@C=12em
%{
%\R\ar[r]^{\Round[5,10]} & \F[5,10]\ar[r]^{->0.25} & \B
%}
%\]


\begin{lstlisting}
/* Precondition: Inputs are distributed uniformly on [0,1] */

half x = ReadInput();
half y = ReadInput();
if (x+y>0.25){
  return TRUE;}
else{
  return FALSE;} 
\end{lstlisting}

This time we want to compute:
\[
\Pro{\mathtt{Prog}(X,Y)=\mathtt{FALSE}\mid X+Y> C}.
\]
This is more complex because we model $\mathtt{Prog}(X,Y)$ by using $+\fp$. We get
\begin{align*}
&\Pro{\mathtt{Prog}(X,Y)=\mathtt{FALSE}\mid X+Y> C}\\
=&\Pro{(u\circ + \circ (\Round\times \Round))(X,Y)\in\{(-\infty,C]\}\mid X+Y>C}\\
&=\int_{C}^{\infty}\left( \int_{\R^2}(u\circ + \circ (\Round\times \Round))(x,y)(-\infty,C]
~\frac{\phi_\mu(x)\phi_\nu(y)}{\phi_\mu\ast\phi_\nu(z)}\delta(z-x-y) ~dx~dy\right)\phi_\mu\ast\phi_\nu(z)~dz\\
&=\int_{C}^{\infty} \int_{-\infty}^\infty (u\circ + \circ (\Round\times \Round))(x,z-x)(-\infty,C]~\phi_\mu(x)\phi_\nu(z-x)~dx~dz\\
&=\int_{C}^{\infty} \int_{-\infty}^\infty u(\Round(x)+\Round(z-x))(-\infty,C]\phi_\mu(x)\phi_\nu(z-x)~dx~dz 
\end{align*}




\begin{itemize}
\item $u(t)(-\infty,C]=0$ if $t>\ceil{C}$. Moreover, 
\item $u(t)(-\infty,C]=\frac{C-\floor{C}}{\ceil{C}-\floor{C}}$ if $\floor{C}\leq t\leq \ceil{C}$
\item $u(t)(-\infty,C]=1$ if $t\leq \floor{C}$
\item $C\leq z$
\end{itemize} 

\begin{lemma}
The following equivalences hold:
\begin{enumerate}
\item $\Round(x)+\Round(z-x)>\ceil{C}\Leftrightarrow \Round(z)>\ceil{C}$
\item $\Round(x)+\Round(z-x)<\floor{C}\Leftrightarrow\Round(z)<\floor{C}$
\end{enumerate}
\end{lemma}
\begin{proof}
\end{proof}

From the first equivalence we get that $u(\Round(x)+\Round(z-x))(-\infty,C]=0$ when  $z>\ceil{C}$ and from the second inequality we get a contradiction with $C\leq z$, i.e. this case does not present itself. Thus the only non-zero contribution is when 
\[
\floor{C}<\Round(z)<\ceil{C}
\]
and the integral above become
\begin{align*}
=&\int_C^{\ceil{C}}\int_{-\infty}^\infty \frac{C-\floor{C}}{\ceil{C}-\floor{C}}\phi_\mu(x)\phi_\nu(z-x)~dx~dz \\
=&\int_C^{\ceil{C}}\int_{-\infty}^\infty \frac{C-\floor{C}}{\ceil{C}-\floor{C}}~\phi_\mu\ast\phi_\nu(z)~dz
\end{align*}
\subsection*{More than one operation}

Consider now a program of the shape
\begin{lstlisting}
/* Precondition: Inputs are distributed uniformly on [0,1] */

half x = ReadInput();
half y = ReadInput();
half z = ReadInput();
if (1+x+(y*z)/2>0.25){
  return TRUE;}
else{
  return FALSE;} 
\end{lstlisting}

The function $\mathtt{1+x+(y*z)/2}$ provides an over-approximation of the distribution of $\mathtt{1+x+(x*x)/2}$, a common approximation of $\mathtt{exp(x)}$. We can consider (1) the distribution of $\mathtt{1+x+(y*z)/2}$ and (2) the probability of misclassification.

Let's start with computing the distribution of $\mathtt{1+x+(y*z)/2}$. We define $\upsilon$ to be the uniform measure on $\intvl{0,1}$. The measure we're looking for is given by the pushforward of the measure $\upsilon\times\upsilon\times\upsilon$ through the sequence of (probabilistic) maps
\[
\xymatrix@C=12ex
{
\R^3\ar[r]^{\langle \id, \times\rangle} & \R^2\ar[r]^{\langle\id,\frac{-}{2}\rangle} & \R^2\ar[r]^{\langle\id,u\rangle} & \R^2 \ar[r]^{+} & \R\ar[r]^{-+1} &\R\ar[r]^{u}&\R
}
\]
Here we assume for simplicity's sake that we can do $(\cdot\times\cdot)/2$ and $1+\cdot+\cdot$ in one operation. We know that the pdf of $((\cdot \times \cdot)/2)_\ast(\upsilon\times\upsilon)$ is given via \eqref{eq:pdftimes} by
\begin{align*}
\phi(t)&=\frac{1}{2}\int_{-\infty}^\infty \frac{1}{\absv{x}} \one_{\intvl{0,1}}(x) \one_{\intvl{0,1}}\left(\frac{t}{x}\right)~dx\\
&=\frac{1}{2}\int_0^\infty \frac{1}{x}\one_{\intvl{0,1}}(x) \one_{\intvl{0,1}}\left(\frac{t}{x}\right)~dx+\int_{-\infty}^0 -\frac{1}{x}\one_{\intvl{0,1}}(x) \one_{\intvl{0,1}}\left(\frac{t}{x}\right)~dx\\
&=\frac{1}{2}\int_0^1 \frac{1}{x}\one_{\intvl{0,1}}\left(\frac{t}{x}\right)~dx\\
&=\frac{1}{2}\one_{\intvl{0,1}}(t)\int_t^1 \frac{1}{x}~dx \\
&=\frac{1}{2}\one_{\intvl{0,1}}(t) (-\log(t))
\end{align*}
And thus thus, the pdf of $(u\circ (\cdot \times \cdot)/2))_\ast(\upsilon\times\upsilon)$ is given via \eqref{eq:updf} by
\begin{align*}
\hat{\phi}(t)&=\sum_{i\in \Rep \left[\F\right]} \one_{\intvl{\floor{i},\ceil{i}}}(t) \int_{\floor{i}}^{\ceil{i}}\frac{\phi(x)}{\ceil{i}-\floor{i}} ~dx\\
&=\sum_{i\in \Rep \left[\F\right]\cap\intvl{0,1}}  \one_{\intvl{\floor{i},\ceil{i}}}(t) \frac{\ceil{i}(1-\log(\ceil{i})-\floor{i}(1-\log(\floor{i})}{\ceil{i}-\floor{i}}
\end{align*}
We can now compute the density of $(1+\cdot+\cdot)\ast$ applied to the product of $(u\circ (\cdot \times \cdot)/2))_\ast(\upsilon\times\upsilon)$  and $\upsilon$ via \eqref{eq:pdftimes}:
\begin{align*}
\psi(t)=\int_{-\infty}^\infty \hat{\phi}(x) \one_{\intvl{1,2}}(t-x)~dx
\end{align*}
\bibliographystyle{plain}
\bibliography{george} 
\end{document}